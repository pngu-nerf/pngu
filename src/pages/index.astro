---
// src/pages/index.astro
import BackgroundEffects from '../components/BackgroundEffects.astro';

// --- Joke Image Logic (Build Time) ---
// This grabs all files in the folder and creates a list of URLs
const jokeFiles = import.meta.glob('/public/site-assets/Joke Images/*.{jpg,jpeg,png,webp,gif}');
const jokeImageUrls = Object.keys(jokeFiles).map(path => path.replace('/public', ''));
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>PNGU</title>
		<style>
            /* 1. CRITICAL FIX: Global Reset */
            * {
                box-sizing: border-box;
            }

			body {
				font-family: sans-serif;
				padding: 2rem;
				text-align: center;
				max-width: 900px;
				margin: 0 auto;
				color: #ffffff;
			}
			
			#bg-layer {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background-color: #0f0f0f;
				z-index: -2;
			}
			
			.banner-container {
				width: 100%;
				margin-bottom: 2rem;
				display: flex;
				justify-content: center;
                padding: 0 10px;
                position: relative; /* Essential for absolute positioning of joke image */
			}
			
			.banner-image {
				width: 100%;
				height: auto;
				border-radius: 12px;
				box-shadow: 0 8px 32px rgba(0,0,0,0.5);
				display: block;
                transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.4s ease;
                cursor: pointer; /* Suggests clickability */
			}

            .banner-image:hover {
                transform: scale(1.015) translateY(-2px);
                box-shadow: 0 12px 40px rgba(0,0,0,0.6);
            }
            
            /* --- Joke Image Styling --- */
            #joke-overlay {
                position: absolute;
                top: 0;
                left: 50%;
                transform: translateX(-50%); /* Center horizontally */
                
                /* Constrain by vertical edges */
                height: 100%; 
                width: auto;
                
                border-radius: 12px;
                pointer-events: none; /* Let clicks pass through so you can click banner again */
                opacity: 0;
                z-index: 10;
                
                /* Default transition for the fade out */
                transition: opacity 3s ease-out;
            }

			.content-box {
				background-color: rgba(40, 40, 40, 0.4); 
                backdrop-filter: blur(20px) saturate(120%);
                -webkit-backdrop-filter: blur(20px) saturate(120%);
                border: 1px solid rgba(255, 255, 255, 0.1);
                
				border-radius: 16px;
				padding: 2rem;
				
				width: 75%;
				margin: 2rem auto; 
				
                text-align: center;
				box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);

                transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), 
                            box-shadow 0.4s ease, 
                            border-color 0.4s ease;
			}

            .content-box:hover {
                transform: scale(1.015) translateY(-2px);
                box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.4);
                border-color: rgba(255, 255, 255, 0.2); 
            }

			h2 {
				margin-top: 0;
				color: #ffffff;
				font-size: 1.5rem;
				border-bottom: 1px solid rgba(255, 255, 255, 0.1);
				padding-bottom: 10px;
				margin-bottom: 20px;
                text-shadow: 0 2px 4px rgba(0,0,0,0.5);
			}

			.nav-list { list-style: none; padding: 0; margin: 0; }
			.nav-item { margin-bottom: 12px; }

			a.nav-link {
				display: flex;
				justify-content: center; 
				align-items: center;
				background-color: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1);
				padding: 16px 20px;
				border-radius: 12px;
				text-decoration: none;
				transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
			}

			a.nav-link:hover {
				background-color: rgba(255, 255, 255, 0.15);
                border-color: rgba(255, 255, 255, 0.3);
				transform: translateY(-3px) scale(1.02);
				box-shadow: 0 8px 20px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
			}

			.link-content {
				display: flex;
				flex-direction: column;
				gap: 4px;
				align-items: center; 
			}

			.link-title {
				color: #ffffff;
				font-weight: bold;
				font-size: 1.1rem;
                letter-spacing: 0.5px;
                text-shadow: 0 2px 4px rgba(0,0,0,0.5);
			}

			.link-desc {
				color: rgba(255, 255, 255, 0.7);
				font-size: 0.9rem;
			}

            .social-title {
                color: #ffffff;
                font-weight: 500;
                text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            }

            /* --- Mobile Specific Fixes --- */
			@media (max-width: 600px) {
				body { 
                    padding: 1rem; 
                }
                
                .content-box { 
					padding: 1.5rem; 
                    width: 100%; 
                    margin: 1.5rem 0;
				}
				
                .banner-container {
                    margin-bottom: 1rem;
                    padding: 0;
                }
                
				.link-desc { display: none; }
			}
		</style>
	</head>
	<body>
		<div id="bg-layer"></div>
		<BackgroundEffects />

		<div class="banner-container" id="banner-trigger">
			<img 
				src="/site-assets/Site Banner.jpg" 
				alt="PNGU Banner"
				class="banner-image"
			/>
            <img src="" id="joke-overlay" alt="Surprise" />
		</div>

		<div class="content-box">
			<ul class="nav-list">
				<li class="nav-item">
					<a href="/files" class="nav-link">
						<div class="link-content">
							<span class="link-title">3D Files</span>
							<span class="link-desc">STL files for 3D printing</span>
						</div>
					</a>
				</li>
				<li class="nav-item">
					<a href="/data" class="nav-link">
						<div class="link-content">
							<span class="link-title">Blaster Data</span>
							<span class="link-desc">Performance spreadsheets & docs</span>
						</div>
					</a>
				</li>
				<li class="nav-item">
					<a href="/brand" class="nav-link">
						<div class="link-content">
							<span class="link-title">Brand Assets</span>
							<span class="link-desc">Logos, fonts, and branding</span>
						</div>
					</a>
				</li>
				<li class="nav-item">
					<a href="/contact" class="nav-link">
						<div class="link-content">
							<span class="link-title">Contact</span>
							<span class="link-desc">Email & Discord info</span>
						</div>
					</a>
				</li>
			</ul>
		</div>

		<div class="content-box">
			<h2>External Links</h2>
			<ul class="nav-list">
				<li class="nav-item">
					<a href="https://www.youtube.com/@PnguNerf" target="_blank" rel="noopener" class="nav-link">
						<span class="social-title">YouTube</span>
					</a>
				</li>
				<li class="nav-item">
					<a href="https://github.com/pngu-nerf" target="_blank" rel="noopener" class="nav-link">
						<span class="social-title">GitHub</span>
					</a>
				</li>
				<li class="nav-item">
					<a href="https://www.printables.com/@PnguNerf_3188348" target="_blank" rel="noopener" class="nav-link">
						<span class="social-title">Printables</span>
					</a>
				</li>
			</ul>
		</div>

		<div style="height: 40px;"></div>

        <script define:vars={{ jokeImageUrls }}>
            // 1. Setup
            const bannerTrigger = document.getElementById('banner-trigger');
            const jokeOverlay = document.getElementById('joke-overlay');
            
            // Queue state
            let imageQueue = [];
            let isAnimating = false;
            let fadeOutTimeout = null;

            // 2. Fisher-Yates Shuffle Algorithm
            function shuffle(array) {
                let currentIndex = array.length, randomIndex;
                // While there remain elements to shuffle.
                while (currentIndex > 0) {
                    // Pick a remaining element.
                    randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;
                    // And swap it with the current element.
                    [array[currentIndex], array[randomIndex]] = [
                        array[randomIndex], array[currentIndex]];
                }
                return array;
            }

            // 3. Get Next Image Logic
            function getNextImage() {
                // If queue is empty, refill it with a fresh shuffle of ALL images
                if (imageQueue.length === 0) {
                    if (jokeImageUrls.length === 0) return null; // Safety check
                    imageQueue = shuffle([...jokeImageUrls]);
                    console.log("Refilled Joke Queue:", imageQueue);
                }
                return imageQueue.pop();
            }

            // 4. Click Handler
            if (bannerTrigger && jokeOverlay && jokeImageUrls.length > 0) {
                bannerTrigger.addEventListener('click', () => {
                    // Prevent spam clicking while the "show" phase is active? 
                    // Optional: Remove this check if you want spamming to just reset the timer
                    if (isAnimating) {
                        // If already showing, just clear the fade out timer and restart the 2s hold
                        clearTimeout(fadeOutTimeout);
                    }

                    const nextImg = getNextImage();
                    if (!nextImg) return;

                    // Set Image
                    jokeOverlay.src = nextImg;
                    isAnimating = true;

                    // Phase 1: Appear Instantly (Fast transition)
                    // We remove the slow transition class temporarily
                    jokeOverlay.style.transition = 'opacity 0.1s ease-in';
                    
                    // Force reflow to ensure transition update applies
                    void jokeOverlay.offsetWidth; 
                    
                    jokeOverlay.style.opacity = '1';

                    // Phase 2: Wait 2 seconds, then Fade Out
                    fadeOutTimeout = setTimeout(() => {
                        // Phase 3: Fade out slowly (3s)
                        jokeOverlay.style.transition = 'opacity 3s ease-out';
                        jokeOverlay.style.opacity = '0';
                        
                        // Reset animating flag after fade completes
                        setTimeout(() => {
                            isAnimating = false;
                        }, 3000);
                        
                    }, 2000); // 2 seconds hold
                });
            } else {
                console.log("No joke images found or elements missing.");
            }
        </script>
	</body>
</html>
