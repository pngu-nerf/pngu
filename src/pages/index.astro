---
import MainLayout from '../layouts/MainLayout.astro';
import NavLink from '../components/NavLink.astro';

// --- Joke Image Logic (Build Time) ---
const jokeFiles = import.meta.glob('/public/site-assets/Joke Images/*.{jpg,jpeg,png,webp,gif}');
const jokeImageUrls = Object.keys(jokeFiles).map(path => path.replace('/public', ''));
---

<MainLayout title="Home">
  <div class="banner-container" id="banner-trigger">
    <img 
      src="/site-assets/Site Banner.png" 
      alt="PNGU Banner"
      class="banner-image"
      loading="eager" 
    />
    <img src="" id="joke-overlay" alt="Surprise" />
  </div>

  <div class="separator">~</div>

  <div class="content-box">
    <ul class="nav-list">
      <NavLink href="/files" title="3D Files" description="STL files for 3D printing" />
      <NavLink href="/data" title="Blaster Data" description="Performance spreadsheets & docs" />
      <NavLink href="/brand" title="Brand Assets" description="Logos, fonts, and branding" />
      <NavLink href="/contact" title="Contact" description="Email & Discord info" />
    </ul>
  </div>

  <div class="separator-small"></div>

  <div class="content-box">
    <h2>External Links</h2>
    <ul class="nav-list">
      <NavLink href="https://www.youtube.com/@PnguNerf" title="YouTube" external />
      <NavLink href="https://github.com/pngu-nerf" title="GitHub" external />
      <NavLink href="https://www.printables.com/@PnguNerf_3188348" title="Printables" external />
    </ul>
  </div>

  <div style="height: 40px;"></div>

  <script define:vars={{ jokeImageUrls }}>
    const bannerTrigger = document.getElementById('banner-trigger');
    const jokeOverlay = document.getElementById('joke-overlay');
    let imageQueue = [];
    let isAnimating = false;
    let fadeOutTimeout = null;

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function getNextImage() {
      if (imageQueue.length === 0) {
        if (jokeImageUrls.length === 0) return null; 
        imageQueue = shuffle([...jokeImageUrls]);
      }
      return imageQueue.pop();
    }

    if (bannerTrigger && jokeOverlay && jokeImageUrls.length > 0) {
      bannerTrigger.addEventListener('click', () => {
        if (isAnimating) clearTimeout(fadeOutTimeout);

        const nextImg = getNextImage();
        if (!nextImg) return;

        jokeOverlay.src = nextImg;
        isAnimating = true;
        jokeOverlay.style.transition = 'opacity 0.1s ease-in';
        void jokeOverlay.offsetWidth; 
        jokeOverlay.style.opacity = '1';

        fadeOutTimeout = setTimeout(() => {
          jokeOverlay.style.transition = 'opacity 3s ease-out';
          jokeOverlay.style.opacity = '0';
          setTimeout(() => { isAnimating = false; }, 3000);
        }, 2000); 
      });
    }
  </script>
</MainLayout>

<style>
  .banner-container {
    width: 100%;
    margin-bottom: 2rem;
    display: flex;
    justify-content: center;
    padding: 0 10px;
    position: relative; 
  }
  
  .banner-image {
    width: 100%;
    height: auto;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    display: block;
    transition: transform var(--transition-bounce), box-shadow 0.4s ease;
    cursor: pointer; 
  }

  .banner-image:hover {
    transform: scale(1.015) translateY(-2px);
    box-shadow: 0 12px 40px rgba(0,0,0,0.6);
  }

  #joke-overlay {
    position: absolute;
    top: 0; left: 50%;
    transform: translateX(-50%); 
    height: 100%; width: auto;
    border-radius: 12px;
    pointer-events: none; 
    opacity: 0;
    z-index: 10;
  }

  .separator { text-align: center; font-size: 2rem; color: rgba(255, 255, 255, 0.3); margin: 3rem 0; font-weight: 300; }
  .separator-small { margin: 2rem 0; height: 20px; }
  .nav-list { list-style: none; padding: 0; margin: 0; }

  @media (max-width: 600px) {
    .banner-container { margin-bottom: 1rem; padding: 0; }
    .separator { margin: 2rem 0; font-size: 1.5rem; }
  }
</style>
