---
import { S3Client, ListObjectsV2Command } from "@aws-sdk/client-s3";
import MainLayout from '../layouts/MainLayout.astro';
import PageHeader from '../components/PageHeader.astro';
import FileItem from '../components/FileItem.astro';

// Initialize the R2 Client
const s3 = new S3Client({
  region: "auto",
  endpoint: "https://3f9488bac1783599afb7ea3af1654150.r2.cloudflarestorage.com",
  credentials: {
    accessKeyId: import.meta.env.R2_ACCESS_KEY_ID,
    secretAccessKey: import.meta.env.R2_SECRET_ACCESS_KEY,
  },
});

const BUCKET_NAME = "pngu-assets";
const ASSET_PREFIX = "PNGU-Blaster-Data-main/";
const R2_DATA_BASE = "https://assets.pngu.info/PNGU-Blaster-Data-main";

let projects = [];

try {
  const command = new ListObjectsV2Command({ 
    Bucket: BUCKET_NAME,
    Prefix: ASSET_PREFIX 
  });
  
  const response = await s3.send(command);
  const files = response.Contents || [];
  const projectMap = {};

  files.forEach(file => {
    // Strip the prefix to get the relative path inside the folder
    const relativeKey = file.Key.replace(ASSET_PREFIX, ""); 
    const parts = relativeKey.split('/');
    
    // We expect: ["Folder Name", "File Name"]
    if (parts.length < 2) return; 

    const folderName = parts[0];
    const fileName = parts[1];

    if (!projectMap[folderName]) {
      projectMap[folderName] = {
        displayName: decodeURIComponent(folderName).replace(/%20/g, ' '),
        folderName: folderName,
        files: []
      };
    }
    
    // Add file if it exists and isn't just the directory placeholder
    if (fileName) {
      projectMap[folderName].files.push(fileName);
    }
  });

  projects = Object.values(projectMap);
} catch (e) {
  console.error("Data Fetch Error:", e);
}
---

<MainLayout title="Blaster Data">
  <PageHeader title="Blaster Data" subtitle="Technical Spreadsheets & Documentation" />

  {projects.length === 0 ? (
    <div class="content-box center-text">
      <p>Updating documentation index or no files found...</p>
    </div>
  ) : (
    projects.map((project) => (
      <div class="content-box">
        <h2>{project.displayName}</h2>
        <div class="file-list">
          {project.files.map((fileName) => {
            const rawUrl = `${R2_DATA_BASE}/${encodeURIComponent(project.folderName)}/${encodeURIComponent(fileName)}`;
            const previewUrl = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(rawUrl)}`;

            return (
              <FileItem name={fileName} downloadUrl={rawUrl} previewType="iframe">
                <div class="preview-container">
                  <iframe 
                    src={previewUrl} 
                    title={`Preview of ${fileName}`} 
                    loading="lazy"
                  ></iframe>
                </div>
              </FileItem>
            );
          })}
        </div>
      </div>
    ))
  )}

  <div class="footer-actions">
    <p class="meta-info">Assets delivered via Cloudflare R2 for maximum speed.</p>
    <a href="https://github.com/pngu-nerf/PNGU-Blaster-Data" target="_blank" class="github-direct-btn">
      View Source Repo &rarr;
    </a>
  </div>
</MainLayout>

<style>
  .center-text { text-align: center; color: var(--text-muted); padding: 2rem; }
  
  .preview-container {
    width: 100%;
    margin-top: 1rem;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--glass-border);
  }

  iframe { 
    width: 100%; 
    height: 600px; 
    border: none; 
    background: #fff; 
  }

  .footer-actions { margin-top: 3rem; text-align: center; padding-bottom: 40px; }
  .meta-info { opacity: 0.5; font-size: 0.8rem; margin-bottom: 0.5rem; }
  
  .github-direct-btn {
    display: inline-block;
    padding: 10px 20px;
    background-color: #272727;
    border: 1px solid var(--glass-border);
    border-radius: 8px;
    color: #fff;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s ease;
  }
  .github-direct-btn:hover { background-color: #333; transform: translateY(-2px); }
</style>
