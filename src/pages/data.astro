---
import MainLayout from '../layouts/MainLayout.astro';
import PageHeader from '../components/PageHeader.astro';
import FileItem from '../components/FileItem.astro';

export const prerender = false;

// --- GitHub Configuration ---
const GITHUB_USER = 'pngu-nerf';
const GITHUB_REPO = 'PNGU-Blaster-Data';
const BRANCH = 'main';

Astro.response.headers.set('Cache-Control', 'public, max-age=1000, s-maxage=1000');

// --- Logic ---
let errorMessage = "";
let projectList = [];
let projects: Record<string, any> = {};

async function getRepoFiles() {
  const apiUrl = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/git/trees/${BRANCH}?recursive=1`;
  const response = await fetch(apiUrl, {
    headers: { 'User-Agent': 'PNGU-Website', 'Accept': 'application/vnd.github.v3+json' }
  });
  if (!response.ok) throw new Error(`GitHub API Error: ${response.status}`);
  return await response.json();
}

try {
  const data = await getRepoFiles();
  if (data?.tree) {
    for (const item of data.tree) {
      if (item.type === 'blob') {
        const pathParts = item.path.split('/');
        if (pathParts.length > 1) {
          const folderName = pathParts[0];
          const fileName = pathParts[pathParts.length - 1];
          const lowerName = fileName.toLowerCase();

          if (!projects[folderName]) projects[folderName] = { title: folderName, files: [] };

          if (['.xlsx', '.xls', '.docx', '.doc'].some(ext => lowerName.endsWith(ext))) {
            const rawUrl = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${BRANCH}/${encodeURIComponent(item.path)}`;
            projects[folderName].files.push({
              name: fileName,
              downloadUrl: rawUrl,
              previewUrl: `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(rawUrl)}`
            });
          }
        }
      }
    }
    projectList = Object.values(projects)
      .map((p: any) => {
        p.files.sort((a, b) => a.name.localeCompare(b.name));
        return p;
      })
      .filter((p: any) => p.files.length > 0);
  }
} catch (error: any) {
  errorMessage = error.message;
}
---

<MainLayout title="Blaster Data">
  <PageHeader title="Blaster Data" subtitle="Spreadsheets & Technical Docs" />

  {errorMessage && <div class="error-box"><strong>Error:</strong> {errorMessage}</div>}

  {projectList.length === 0 && !errorMessage ? (
    <div class="content-box center-text">
      <p>No spreadsheets or documents found.</p>
    </div>
  ) : (
    projectList.map((project) => (
      <div class="content-box">
        <h2>{project.title}</h2>
        <div class="file-list">
          {project.files.map((file) => (
            <FileItem name={file.name} downloadUrl={file.downloadUrl} previewType="iframe">
              <div class="preview-container">
                <iframe src={file.previewUrl} title={`Preview of ${file.name}`} loading="lazy"></iframe>
              </div>
            </FileItem>
          ))}
        </div>
      </div>
    ))
  )}

  <div class="footer-actions">
    <p class="meta-info">Files hosted on GitHub. Updates every ~10 minutes.</p>
    <a href={`https://github.com/${GITHUB_USER}/${GITHUB_REPO}`} target="_blank" class="github-direct-btn">
      Access GitHub Directly &rarr;
    </a>
  </div>
</MainLayout>

<style>
  /* Page-specific overrides */
  .center-text { text-align: center; color: var(--text-muted); }
  
  .error-box {
    background-color: rgba(63, 26, 26, 0.8);
    border: 1px solid #ff4444;
    color: #ffcccc;
    padding: 1rem;
    border-radius: 12px;
    width: 75%;
    margin: 0 auto 2rem auto;
  }

  /* Preview iFrame handling */
  iframe { width: 100%; height: 500px; border: none; }

  .footer-actions { margin-top: 3rem; text-align: center; padding-bottom: 40px; }
  .meta-info { opacity: 0.5; font-size: 0.8rem; margin-bottom: 0.5rem; }
  
  .github-direct-btn {
    display: inline-block;
    padding: 10px 20px;
    background-color: #272727;
    border: 1px solid var(--glass-border);
    border-radius: 8px;
    color: #fff;
    text-decoration: none;
    font-weight: 500;
    transition: all var(--transition-base);
  }
  .github-direct-btn:hover { background-color: #333; transform: translateY(-2px); }
</style>
