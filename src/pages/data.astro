---
import { getR2Data } from '../lib/r2';
import { R2_DATA_BASE } from '../constants';
import MainLayout from '../layouts/MainLayout.astro';
import PageHeader from '../components/PageHeader.astro';
import FileItem from '../components/FileItem.astro';

/** * FETCH LOGIC
 * The actual work is now outsourced to '../lib/r2'. 
 * We simply ask for the folder we want to display.
 */
const projects = await getR2Data("PNGU-Blaster-Data-main/");
---

<MainLayout title="Blaster Data">
  <PageHeader title="Blaster Data" subtitle="Technical Spreadsheets & Documentation" />

  {projects.length === 0 ? (
    <div class="content-box center-text">
      <p>Updating documentation index or no files found...</p>
      <p class="debug-hint">Check your R2 keys in Cloudflare and ensure nodejs_compat is enabled.</p>
    </div>
  ) : (
    projects.map((project: any) => (
      <div class="content-box">
        <h2>{project.displayName}</h2>
        <div class="file-list">
          {project.files.map((fileName: string) => {
            // URL construction using centralized constant
            const rawUrl = `${R2_DATA_BASE}/${encodeURIComponent(project.folderName)}/${encodeURIComponent(fileName)}`;
            const previewUrl = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(rawUrl)}`;

            return (
              <FileItem name={fileName} downloadUrl={rawUrl} previewType="iframe">
                <div class="preview-container">
                  <iframe 
                    src={previewUrl} 
                    title={`Preview of ${fileName}`} 
                    loading="lazy"
                  ></iframe>
                </div>
              </FileItem>
            );
          })}
        </div>
      </div>
    ))
  )}

  <div class="footer-actions">
    <p class="meta-info">Assets delivered via Cloudflare R2 for maximum speed.</p>
    <a href="https://github.com/pngu-nerf/PNGU-Blaster-Data" target="_blank" class="github-direct-btn">
      View Source Repo &rarr;
    </a>
  </div>
</MainLayout>

<style>
  .center-text { text-align: center; color: var(--text-muted); padding: 2rem; }
  .debug-hint { font-size: 0.8rem; opacity: 0.6; margin-top: 0.5rem; }
  
  .preview-container {
    width: 100%;
    margin-top: 1rem;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--glass-border);
  }

  /* Microsoft Office Preview Iframe Styles */
  iframe { 
    width: 100%; 
    height: 600px; 
    border: none; 
    background: #fff; 
  }

  .footer-actions { margin-top: 3rem; text-align: center; padding-bottom: 40px; }
  .meta-info { opacity: 0.5; font-size: 0.8rem; margin-bottom: 0.5rem; }
  
  .github-direct-btn {
    display: inline-block;
    padding: 10px 20px;
    background-color: #272727;
    border: 1px solid var(--glass-border);
    border-radius: 8px;
    color: #fff;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s ease;
  }
  .github-direct-btn:hover { background-color: #333; transform: translateY(-2px); }
</style>
