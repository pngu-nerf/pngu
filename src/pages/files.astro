---
import MainLayout from '../layouts/MainLayout.astro';
import PageHeader from '../components/PageHeader.astro';
import FileItem from '../components/FileItem.astro';

export const prerender = false;

// --- Configuration ---
const GITHUB_USER = 'pngu-nerf';
const GITHUB_REPO = 'PNGU-3D-Files';
const BRANCH = 'main';

Astro.response.headers.set('Cache-Control', 'public, max-age=1000, s-maxage=1000');

// --- Types & Variables ---
let errorMessage = "";
let projectList: any[] = [];
let projects: Record<string, any> = {};

async function getRepoFiles() {
  const apiUrl = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/git/trees/${BRANCH}?recursive=1`;
  const response = await fetch(apiUrl, {
    headers: { 'User-Agent': 'PNGU-Website', 'Accept': 'application/vnd.github.v3+json' }
  });
  if (!response.ok) throw new Error(`GitHub API Error: ${response.status}`);
  return await response.json();
}

// Logic to fetch description from Printables Meta tags
async function getPrintablesDescription(url: string) {
  if (!url) return "No description available.";
  try {
    const res = await fetch(url, { headers: { 'User-Agent': 'PNGU-Website' } });
    const html = await res.text();
    const match = html.match(/<meta\s+name="description"\s+content="([^"]*)"/i) || 
                  html.match(/<meta\s+property="og:description"\s+content="([^"]*)"/i);
    return match ? match[1].replace(/&quot;/g, '"').replace(/&#39;/g, "'") : "Description found on Printables.";
  } catch (e) { return "Error loading description."; }
}

try {
  const data = await getRepoFiles();
  if (data?.tree) {
    for (const item of data.tree) {
      if (item.type === 'blob') {
        const pathParts = item.path.split('/');
        if (pathParts.length > 1) {
          const folderName = pathParts[0];
          const fileName = pathParts[pathParts.length - 1];

          if (!projects[folderName]) {
            projects[folderName] = { title: folderName, description: "Loading...", printablesUrl: null, files: [] };
          }

          if (fileName.toLowerCase().endsWith('.stl')) {
            const safePath = item.path.split('/').map(encodeURIComponent).join('/');
            projects[folderName].files.push({
              name: fileName,
              url: `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${BRANCH}/${safePath}`
            });
          }
          
          if (fileName.toLowerCase().includes('link')) {
             const res = await fetch(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${BRANCH}/${item.path}`);
             if (res.ok) projects[folderName].printablesUrl = (await res.text()).trim();
          }

          if (fileName.toLowerCase().startsWith('description')) {
             const res = await fetch(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${BRANCH}/${item.path}`);
             if (res.ok) projects[folderName].description = (await res.text()).trim();
          }
        }
      }
    }

    await Promise.all(Object.values(projects).map(async (project: any) => {
        if (project.description === "Loading...") {
            project.description = project.printablesUrl ? await getPrintablesDescription(project.printablesUrl) : "No description available.";
        }
        project.files.sort((a: any, b: any) => a.name.localeCompare(b.name));
    }));
    projectList = Object.values(projects).filter((p: any) => p.files.length > 0);
  }
} catch (error: any) { errorMessage = error.message; }
---

<MainLayout title="3D Files">
  <PageHeader title="3D Printing Files" subtitle="Files synced from GitHub" />

  {errorMessage && <div class="error-box"><strong>Error:</strong> {errorMessage}</div>}

  {projectList.length === 0 && !errorMessage ? (
    <div class="content-box center-text">
      <p>No files found in repo.</p>
    </div>
  ) : (
    projectList.map((project) => (
      <div class="content-box">
        <h2>{project.title}</h2>
        
        <details class="project-desc">
          <summary>Project Info</summary>
          <div class="description-content">
            {project.description}
            {project.printablesUrl && (
              <a href={project.printablesUrl} target="_blank" class="printables-link">
                View on Printables &rarr;
              </a>
            )}
          </div>
        </details>

        <div class="file-list">
          {project.files.map((file: any) => (
            <FileItem name={file.name} downloadUrl={file.url} previewType="stl">
              <div class="viewer-container" data-stl-url={file.url}>
                <span class="loading-text">Click to load 3D view...</span>
              </div>
            </FileItem>
          ))}
        </div>
      </div>
    ))
  )}

  <div class="footer-actions">
    <a href={`https://github.com/${GITHUB_USER}/${GITHUB_REPO}`} target="_blank" class="github-direct-btn">
      Access GitHub Directly &rarr;
    </a>
  </div>

  <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { STLLoader } from 'three/addons/loaders/STLLoader.js';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    const viewedElements = new WeakSet();

    function initViewer(container, url) {
        if (viewedElements.has(container)) return;
        viewedElements.add(container);

        const loadingText = container.querySelector('.loading-text');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        
        const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
        scene.add(ambientLight);

        const loader = new STLLoader();
        loader.load(url, (geometry) => {
            if (loadingText) loadingText.style.display = 'none';
            geometry.center();
            const material = new THREE.MeshPhongMaterial({ color: 0xffffff, specular: 0x111111, shininess: 100 });
            const mesh = new THREE.Mesh(geometry, material);
            mesh.rotation.x = -Math.PI / 2;
            scene.add(mesh);

            geometry.computeBoundingBox();
            const size = geometry.boundingBox.getSize(new THREE.Vector3()).length();
            camera.position.z = size * 1.5;
            
            const animate = () => { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); };
            animate();
        });
    }

    document.addEventListener('toggle', (e) => {
        if (e.target.open && e.target.classList.contains('file-item')) {
            const container = e.target.querySelector('.viewer-container');
            if (container) initViewer(container, container.dataset.stlUrl);
        }
    }, true);
  </script>
</MainLayout>

<style>
  .center-text { text-align: center; }
  
  /* Project Description Styling */
  .project-desc {
    background-color: rgba(31, 31, 31, 0.6);
    border-radius: 8px;
    margin-bottom: 1.5rem;
    border: 1px solid var(--glass-border);
    overflow: hidden;
  }
  .project-desc summary { padding: 1rem; font-weight: bold; cursor: pointer; color: #e0e0e0; }
  .description-content { padding: 1rem; line-height: 1.6; color: #ccc; white-space: pre-wrap; border-top: 1px solid var(--glass-border); }
  
  .printables-link { display: block; margin-top: 15px; color: var(--accent-white); text-decoration: underline; font-size: 0.9rem; }

  /* 3D Viewer Placeholder */
  .viewer-container { height: 400px; display: flex; align-items: center; justify-content: center; }
  .loading-text { color: #666; font-size: 0.9rem; }

  .footer-actions { margin-top: 3rem; text-align: center; padding-bottom: 60px; }
  .github-direct-btn {
    display: inline-block; padding: 12px 24px; background: #272727; border: 1px solid var(--glass-border); border-radius: 8px; color: #fff; text-decoration: none; transition: 0.2s;
  }
  .github-direct-btn:hover { background: #333; transform: translateY(-2px); }
</style>
