---
import BackgroundEffects from '../components/BackgroundEffects.astro';
import { getR2Data } from '../lib/r2';
import { R2_FILES_BASE } from '../constants';

const currentYear = new Date().getFullYear();

let projects: any[] = [];
try {
    const rawProjects = await getR2Data("PNGU-3D-Files-main/");
    
    projects = await Promise.all(rawProjects.map(async (project) => {
        // Filter out the meta files from the main download list
        const assetFiles = project.files.filter((f: string) => f !== 'description' && f !== 'link');
        
        // Check for meta files
        const hasDescription = project.files.includes('description');
        const hasLink = project.files.includes('link');

        // Construct URLs for meta files
        const descUrl = hasDescription ? `${R2_FILES_BASE}/${encodeURIComponent(project.folderName)}/description` : null;
        const linkUrl = hasLink ? `${R2_FILES_BASE}/${encodeURIComponent(project.folderName)}/link` : null;

        // Fetch description content during build for instant loading
        let descriptionText = "";
        let externalLink = "";

        if (descUrl) {
            try {
                const res = await fetch(descUrl);
                descriptionText = await res.text();
            } catch (e) { descriptionText = "Description currently unavailable."; }
        }

        if (linkUrl) {
            try {
                const res = await fetch(linkUrl);
                externalLink = await res.text();
            } catch (e) { externalLink = ""; }
        }

        return {
            title: project.displayName,
            description: descriptionText,
            printablesLink: externalLink.trim(),
            files: assetFiles.map((fileName: string) => ({
                name: fileName,
                url: `${R2_FILES_BASE}/${encodeURIComponent(project.folderName)}/${encodeURIComponent(fileName)}`
            }))
        };
    }));
    
    projects.sort((a, b) => a.title.localeCompare(b.title));
} catch (e) {
    console.error("R2 Fetch Error:", e);
}

// ... (Keep the existing grouped and sortedLetters logic)
const grouped = projects.reduce((acc, project) => {
    const char = project.title[0].toUpperCase();
    const key = /[A-Z]/.test(char) ? char : "#";
    if (!acc[key]) acc[key] = [];
    acc[key].push(project);
    return acc;
}, {} as Record<string, any[]>);

const sortedLetters = Object.keys(grouped).sort((a, b) => {
    if (a === "#") return 1;
    if (b === "#") return -1;
    return a.localeCompare(b);
});
---

<html lang="en">
    <style>
        /* Add these new styles to your existing <style> block */
        .meta-dropdown {
            margin-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            padding-top: 15px;
        }
        .meta-dropdown summary {
            padding: 10px 0;
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.7rem;
            font-weight: 800;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }
        .description-content {
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.5;
            color: #ccc;
            white-space: pre-wrap; /* Preserves line breaks from the file */
        }
        .printables-btn {
            display: block;
            margin-top: 15px;
            color: #0df; /* Abyssal blue highlight */
            text-decoration: none;
            font-weight: 700;
            font-size: 0.8rem;
        }
        .printables-btn:hover { text-decoration: underline; }
    </style>

    <body>
        <div id="results-container">
            {sortedLetters.map((letter) => (
                <div class="letter-group" data-letter={letter}>
                    <div class="letter-header">{letter}</div>
                    {grouped[letter].map((project) => (
                        <div class="content-box project-card" data-title={project.title.toLowerCase()}>
                            <h2>{project.title}</h2>
                            <div class="file-list">
                                {project.files.map((file: any) => (
                                    <details class="file-dropdown" data-filename={file.name.toLowerCase()}>
                                        <summary>
                                            <div class="summary-header">
                                                <span class="file-name">{file.name}</span>
                                                <span class="preview-text">3D PREVIEW ▼</span>
                                            </div>
                                            <a href={file.url} class="download-btn" download onclick="event.stopPropagation();">
                                                Download STL
                                            </a>
                                        </summary>
                                        <div class="preview-wrap">
                                            <div class="viewer-container" data-stl-url={file.url}>
                                                <span class="loading-text">Initializing 3D Engine...</span>
                                            </div>
                                        </div>
                                    </details>
                                ))}
                            </div>

                            {/* New Description & Link Section */}
                            {(project.description || project.printablesLink) && (
                                <details class="meta-dropdown">
                                    <summary>Project Details ▼</summary>
                                    <div class="description-content">
                                        {project.description && <p>{project.description}</p>}
                                        {project.printablesLink && (
                                            <a href={project.printablesLink} target="_blank" class="printables-btn">
                                                View on Printables →
                                            </a>
                                        )}
                                    </div>
                                </details>
                            )}
                        </div>
                    ))}
                </div>
            ))}
        </div>
        </body>
</html>
