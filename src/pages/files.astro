---
import MainLayout from '../layouts/MainLayout.astro';
import PageHeader from '../components/PageHeader.astro';
import FileItem from '../components/FileItem.astro';

// Use local data for instant builds
import projectDatabase from '../content/files-database.json';

const R2_BASE_URL = "https://assets.pngu.info/PNGU-3D-Files-main";

/* Each project in your JSON should look like:
  {
    "folderName": "Cynthia Bolt Remix",
    "displayName": "Cynthia Bolt Remix",
    "description": "...",
    "printablesUrl": "...",
    "stlFiles": ["part1.stl", "part2.stl"]
  }
*/
---

<MainLayout title="3D Files">
  <PageHeader title="3D Printing Files" subtitle="High-speed delivery via Cloudflare R2" />

  {projectDatabase.length === 0 ? (
    <div class="content-box center-text">
      <p>Updating database...</p>
    </div>
  ) : (
    projectDatabase.map((project) => (
      <div class="content-box">
        <h2>{project.displayName}</h2>
        
        <details class="project-desc">
          <summary>Project Info</summary>
          <div class="description-content">
            {project.description}
            {project.printablesUrl && (
              <a href={project.printablesUrl} target="_blank" class="printables-link">
                View on Printables &rarr;
              </a>
            )}
          </div>
        </details>

        <div class="file-list">
          {project.stlFiles.map((fileName) => {
            // Construct the direct R2 URL
            const fileUrl = `${R2_BASE_URL}/${encodeURIComponent(project.folderName)}/${encodeURIComponent(fileName)}`;
            
            return (
              <FileItem name={fileName} downloadUrl={fileUrl} previewType="stl">
                <div class="viewer-container" data-stl-url={fileUrl}>
                  <span class="loading-text">Click to load 3D view...</span>
                </div>
              </FileItem>
            );
          })}
        </div>
      </div>
    ))
  )}

  <div class="footer-actions">
    <a href="https://github.com/pngu-nerf/PNGU-3D-Files" target="_blank" class="github-direct-btn">
      Source Repository &rarr;
    </a>
  </div>

  <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { STLLoader } from 'three/addons/loaders/STLLoader.js';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    const viewedElements = new WeakSet();

    function initViewer(container, url) {
        if (viewedElements.has(container)) return;
        viewedElements.add(container);

        const loadingText = container.querySelector('.loading-text');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        
        const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
        scene.add(ambientLight);

        const loader = new STLLoader();
        // R2 handles these requests much faster than GitHub Raw
        loader.load(url, (geometry) => {
            if (loadingText) loadingText.style.display = 'none';
            geometry.center();
            const material = new THREE.MeshPhongMaterial({ color: 0xffffff, specular: 0x111111, shininess: 100 });
            const mesh = new THREE.Mesh(geometry, material);
            mesh.rotation.x = -Math.PI / 2;
            scene.add(mesh);

            geometry.computeBoundingBox();
            const size = geometry.boundingBox.getSize(new THREE.Vector3()).length();
            camera.position.z = size * 1.5;
            
            const animate = () => { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); };
            animate();
        });
    }

    document.addEventListener('toggle', (e) => {
        if (e.target.open && e.target.classList.contains('file-item')) {
            const container = e.target.querySelector('.viewer-container');
            if (container) initViewer(container, container.dataset.stlUrl);
        }
    }, true);
  </script>
</MainLayout>

<style>
  .center-text { text-align: center; }
  .project-desc {
    background-color: rgba(31, 31, 31, 0.6);
    border-radius: 8px;
    margin-bottom: 1.5rem;
    border: 1px solid var(--glass-border);
    overflow: hidden;
  }
  .project-desc summary { padding: 1rem; font-weight: bold; cursor: pointer; color: #e0e0e0; }
  .description-content { padding: 1rem; line-height: 1.6; color: #ccc; white-space: pre-wrap; border-top: 1px solid var(--glass-border); }
  .printables-link { display: block; margin-top: 15px; color: #fff; text-decoration: underline; font-size: 0.9rem; }
  .viewer-container { height: 400px; display: flex; align-items: center; justify-content: center; }
  .loading-text { color: #666; font-size: 0.9rem; }
  .footer-actions { margin-top: 3rem; text-align: center; padding-bottom: 60px; }
  .github-direct-btn {
    display: inline-block; padding: 12px 24px; background: #272727; border: 1px solid var(--glass-border); border-radius: 8px; color: #fff; text-decoration: none; transition: 0.2s;
  }
  .github-direct-btn:hover { background: #333; transform: translateY(-2px); }
</style>
