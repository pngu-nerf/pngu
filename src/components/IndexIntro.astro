---
/* IndexIntro.astro - Sub-Pixel Alignment Fix */
---

<div id="intro-blackout"></div>
<div id="wipe-layer"></div>
<div id="intro-banner-overlay"></div>

<style is:global>
  html {
    /* Prevents horizontal layout shifting when scrollbar toggles */
    scrollbar-gutter: stable !important;
  }

  html.is-intro-locked,
  body.is-intro-locked {
    overflow: hidden !important;
    height: 100vh !important;
    width: 100% !important;
    touch-action: none;
  }

  /* 1. INITIAL HIDE */
  body.is-intro .index-header,
  body.is-intro .content-box,
  body.is-intro .separator,
  body.is-intro .separator-small {
    opacity: 0;
    visibility: hidden;
    /* Reduced to 4px to minimize the "travel" distance */
    transform: translateY(4px);
  }

  /* 2. PERSISTENT LOGO OVERLAY */
  #intro-banner-overlay {
    position: fixed;
    z-index: 10001; 
    pointer-events: none;
    display: none;
    opacity: 1;
    will-change: opacity, transform;
    /* Added the exact shadow from your index.astro to prevent "weight" shifting */
    filter: drop-shadow(0 10px 15px rgba(0, 0, 0, 0.6));
  }

  #intro-banner-overlay img {
    width: 100%;
    height: auto;
    display: block;
  }

  /* 3. CURTAIN LAYERS */
  #intro-blackout {
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 10000;
  }

  #wipe-layer {
    position: fixed;
    inset: 0;
    height: 400vh;
    z-index: 9999;
    background: linear-gradient(to bottom, #000 0%, #000 75%, transparent 100%);
    transform: translateY(0); 
    pointer-events: none;
  }

  .animate-wipe {
    transition: transform 0.9s cubic-bezier(0.19, 1, 0.22, 1);
  }

  /* 4. REVEAL STATES */
  .reveal-active {
    visibility: visible !important;
    opacity: 1 !important;
    transform: translateY(0) !important;
    transition: 
      opacity 0.25s ease-out, 
      transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.1) !important;
  }

  .reveal-static {
    visibility: visible !important;
    opacity: 1 !important;
    /* Slower fade for the header/tilde to blend with the overlay fade */
    transition: opacity 0.5s linear !important; 
  }
</style>

<script>
  function runIntro() {
    const internalReferrer = document.referrer && document.referrer.includes(window.location.hostname);
    const blackout = document.getElementById('intro-blackout');
    const wipe = document.getElementById('wipe-layer');
    const overlay = document.getElementById('intro-banner-overlay');
    const actualBanner = document.querySelector('.banner-image') as HTMLImageElement;

    if (internalReferrer) {
      blackout?.remove();
      wipe?.remove();
      overlay?.remove();
      return; 
    }

    if (!actualBanner || !overlay) return;

    // A. LOCK FIRST (Important: do this before measuring)
    window.scrollTo(0, 0);
    document.documentElement.classList.add('is-intro-locked');
    document.body.classList.add('is-intro-locked');
    document.body.classList.add('is-intro');

    // B. MEASURE SECOND (Measuring while locked is more accurate)
    const rect = actualBanner.getBoundingClientRect();
    overlay.style.width = `${rect.width}px`;
    overlay.style.top = `${rect.top}px`;
    overlay.style.left = `${rect.left}px`;
    overlay.innerHTML = `<img src="${actualBanner.src}" alt="Overlay Banner">`;
    overlay.style.display = 'block';

    // C. THE 2s HOLD
    setTimeout(() => {
      if (blackout) blackout.style.display = 'none';
      if (wipe) {
        wipe.classList.add('animate-wipe');
        wipe.style.transform = 'translateY(-100%)';
      }

      // D. THE OVERLAPPING REVEAL (175ms in)
      setTimeout(() => {
        // Reveal Real Header & Tilde
        const header = document.querySelector('.index-header');
        const separator = document.querySelector('.index-header .separator');
        if (header) header.classList.add('reveal-static');
        if (separator) (separator as HTMLElement).classList.add('reveal-static');

        // Reveal Content Blocks
        const uiElements = document.querySelectorAll('.content-box, .separator-small');
        uiElements.forEach((el, index) => {
          setTimeout(() => {
            el.classList.add('reveal-active');
          }, index * 20); 
        });

        // Slow cross-fade
        overlay.style.opacity = '0';
        overlay.style.transition = 'opacity 0.6s ease-in-out';
      }, 175);

      // E. FINAL RELEASE (1.4s total + small ghost buffer)
      setTimeout(() => {
        // Remove overlay/wipe elements first
        overlay?.remove();
        wipe?.remove();
        blackout?.remove();

        // One last micro-delay to let the browser settle after DOM removal
        setTimeout(() => {
          document.body.classList.remove('is-intro');
          document.documentElement.classList.remove('is-intro-locked');
          document.body.classList.remove('is-intro-locked');
        }, 100);
      }, 1400);

    }, 2000); 
  }

  window.addEventListener('load', runIntro);
</script>
