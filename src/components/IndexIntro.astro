---
/* IndexIntro.astro - Center-to-Header Translation Logic */
---

<div id="intro-blackout"></div>
<div id="wipe-layer"></div>
<div id="intro-banner-overlay"></div>

<style is:global>
  html.is-intro-locked,
  body.is-intro-locked {
    overflow: hidden !important;
    height: 100vh !important;
    touch-action: none;
  }

  body.is-intro .index-header {
    opacity: 0.01;
    visibility: visible !important;
    height: var(--header-height, auto);
    margin: 0 !important;
    padding: 0 !important;
    pointer-events: none;
  }

  body.is-intro .content-box,
  body.is-intro .separator,
  body.is-intro .separator-small {
    opacity: 0;
    visibility: hidden;
    transform: translateY(4px);
  }

  /* OVERLAY - Now supports translation */
  #intro-banner-overlay {
    position: fixed;
    z-index: 10001; 
    pointer-events: none;
    display: none;
    opacity: 0;
    will-change: opacity, transform, top, left;
    transform: translateZ(0); 
    -webkit-font-smoothing: antialiased;
  }

  #intro-banner-overlay img {
    width: 100%;
    height: auto;
    display: block;
  }

  /* CURTAIN */
  #intro-blackout {
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 10000;
  }

  #wipe-layer {
    position: fixed;
    inset: 0;
    height: 100vh;
    z-index: 9999;
    background: #000;
    -webkit-mask-image: linear-gradient(to bottom, black 85%, transparent 100%);
    mask-image: linear-gradient(to bottom, black 85%, transparent 100%);
    transform: translateY(0); 
    pointer-events: none;
    will-change: transform;
    -webkit-backface-visibility: hidden;
  }

  .animate-wipe {
    transition: transform 0.9s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .reveal-static {
    opacity: 1 !important;
    pointer-events: auto !important;
    transition: opacity 0.1s linear !important;
  }

  .reveal-active {
    visibility: visible !important;
    opacity: 1 !important;
    transform: translateY(0) !important;
    transition: 
      opacity 0.2s ease-out, 
      transform 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.1) !important;
  }
</style>

<script>
  function runIntro() {
    const internalReferrer = document.referrer && document.referrer.includes(window.location.hostname);
    const blackout = document.getElementById('intro-blackout');
    const wipe = document.getElementById('wipe-layer');
    const overlay = document.getElementById('intro-banner-overlay');
    const header = document.querySelector('.index-header') as HTMLElement;
    const actualBanner = document.querySelector('.banner-image') as HTMLImageElement;

    if (internalReferrer) {
      blackout?.remove();
      wipe?.remove();
      overlay?.remove();
      return; 
    }

    if (!actualBanner || !overlay || !header) return;

    window.scrollTo(0, 0);

    // 1. MEASURE POSITIONS
    const finalRect = actualBanner.getBoundingClientRect();
    const headerHeight = header.offsetHeight;
    document.documentElement.style.setProperty('--header-height', `${headerHeight}px`);

    // Calculate Center Start Position
    const startWidth = finalRect.width;
    const startLeft = (window.innerWidth - startWidth) / 2;
    const startTop = (window.innerHeight - (startWidth * (finalRect.height / finalRect.width))) / 2;

    // 2. INITIAL SETUP (DEAD CENTER)
    overlay.style.width = `${startWidth}px`;
    overlay.style.top = `${startTop}px`;
    overlay.style.left = `${startLeft}px`;
    overlay.innerHTML = `<img src="${actualBanner.src}" alt="" style="width:100%; height:auto; display:block;">`;
    overlay.style.display = 'block';

    document.documentElement.classList.add('is-intro-locked');
    document.body.classList.add('is-intro-locked');
    document.body.classList.add('is-intro');

    // ACT 0: 2s FADE IN AT CENTER
    requestAnimationFrame(() => {
        overlay.style.transition = 'opacity 2.0s ease-in-out';
        overlay.style.opacity = '1';
    });

    // ACT I: THE MOVEMENT (Starts after 2s fade)
    setTimeout(() => {
      // Begin Wipe
      if (blackout) blackout.style.display = 'none';
      if (wipe) {
        wipe.classList.add('animate-wipe');
        wipe.style.transform = 'translateY(-110%)'; 
      }

      // Begin Translation to Header
      overlay.style.transition = 'top 0.8s cubic-bezier(0.16, 1, 0.3, 1), left 0.8s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease-out';
      overlay.style.top = `${finalRect.top}px`;
      overlay.style.left = `${finalRect.left}px`;

      // ACT II: THE SNAP REVEAL (Occurs during the slide)
      setTimeout(() => {
        header.classList.add('reveal-static');

        const uiElements = document.querySelectorAll('.content-box, .separator, .separator-small');
        uiElements.forEach((el, index) => {
          setTimeout(() => {
            el.classList.add('reveal-active');
          }, index * 20); 
        });

        // Hide overlay shield after it arrives
        setTimeout(() => {
          overlay.style.opacity = '0';
        }, 150);
      }, 500); // Trigger mid-slide

      // ACT III: EXTENDED LOCK (0.5s settle)
      // Total wait = Wipe (0.9s) + Settle (0.5s) = 1400ms
      setTimeout(() => {
        document.documentElement.classList.remove('is-intro-locked');
        document.body.classList.remove('is-intro-locked');
        document.body.classList.remove('is-intro');

        setTimeout(() => {
          wipe?.remove();
          blackout?.remove();
          overlay?.remove();
        }, 200);
      }, 1400); 

    }, 2500); // 2s Fade + 0.5s static hold at center
  }

  window.addEventListener('load', runIntro);
</script>
