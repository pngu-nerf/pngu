---
// src/components/BackgroundEffects.astro
---
<canvas id="tech-canvas"></canvas>

<style>
    #tech-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        pointer-events: none;
        
        opacity: 0;
        /* 1. FASTER FADE: Duration 1s, Delay reduced to 1s */
        animation: subtleFadeIn 1s ease-in-out 1s forwards;
    }

    @keyframes subtleFadeIn {
        from { opacity: 0; }
        to { opacity: 0.3; } 
    }
</style>

<script>
    const canvas = document.getElementById('tech-canvas') as HTMLCanvasElement;
    const ctx = canvas.getContext('2d');

    let width, height;
    let strands = [];
    
    let mouseX = -1000;
    let mouseSpeedX = 0;

    window.addEventListener('mousemove', (e) => {
        mouseSpeedX = e.movementX;
        mouseX = e.clientX;
    });

    const STRAND_COUNT = 15;
    const STRAND_COLOR = '255, 255, 255'; 

    class Strand {
        x: number;
        length: number;
        thickness: number;
        offset: number;
        amplitude: number;
        frequency: number;
        
        // Physics
        strumVal: number; 
        strumVel: number; 
        
        // 2. GLOW STATE
        highlight: number; // 0 to 1, indicates "excitement"

        constructor() {
            this.init();
        }

        init() {
            this.x = Math.random() * width;
            this.length = height; 
            
            this.thickness = Math.random() * 4 + 1; 
            
            this.offset = Math.random() * 100; 
            this.amplitude = Math.random() * 50 + 20; 
            this.frequency = Math.random() * 0.002 + 0.001; 
            
            this.strumVal = 0;
            this.strumVel = 0;
            this.highlight = 0;
        }

        update() {
            this.offset += 0.005;

            // Physics (Spring)
            const tension = 0.05; 
            const damping = 0.95; 
            
            const force = -tension * this.strumVal;
            this.strumVel += force;
            this.strumVel *= damping; 
            this.strumVal += this.strumVel;

            // Decay the highlight (fade out the extra glow)
            this.highlight *= 0.9; 

            // Mouse Interaction
            const dist = Math.abs(mouseX - this.x);
            
            if (dist < 50) {
                // Add velocity based on mouse speed
                this.strumVel += mouseSpeedX * 0.05;
                
                // 3. TRIGGER GLOW: Spike highlight to 1.0 on contact
                // We add a little absolute value from speed to make hard hits brighter
                this.highlight = Math.min(this.highlight + 0.2 + Math.abs(mouseSpeedX * 0.01), 1.0);
            }
        }

        draw() {
            if (!ctx) return;
            
            ctx.beginPath();
            
            const grad = ctx.createLinearGradient(this.x, 0, this.x, height);
            grad.addColorStop(0, `rgba(${STRAND_COLOR}, 0)`);
            grad.addColorStop(0.5, `rgba(${STRAND_COLOR}, 1.0)`); 
            grad.addColorStop(1, `rgba(${STRAND_COLOR}, 0)`);

            ctx.strokeStyle = grad;
            
            // 4. DYNAMIC THICKNESS: Gets slightly thicker when highlighted
            ctx.lineWidth = this.thickness + (this.highlight * 3);
            ctx.lineCap = 'round';
            
            const segments = 25;
            const segmentHeight = this.length / segments;

            ctx.moveTo(
                this.x + Math.sin(this.offset) * this.amplitude, 
                0
            );

            for (let i = 0; i <= segments; i++) {
                let currentY = segmentHeight * i;
                
                const ambientSway = Math.sin(this.offset + (i * 0.2)) * this.amplitude;
                const strumEffect = this.strumVal * Math.sin((i / segments) * Math.PI);
                
                ctx.lineTo(this.x + ambientSway + strumEffect, currentY);
            }

            // 5. DYNAMIC GLOW: Blur increases significantly based on highlight
            // Base blur 15, adds up to 30 more (total 45) when strummed
            ctx.shadowBlur = 15 + (this.highlight * 30);
            
            // Make the shadow stronger white when highlighted
            ctx.shadowColor = `rgba(255, 255, 255, ${0.5 + this.highlight * 0.5})`;

            ctx.stroke();
            
            ctx.shadowBlur = 0; 
        }
    }

    function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
        
        strands = [];
        for (let i = 0; i < STRAND_COUNT; i++) {
            strands.push(new Strand());
        }
    }

    function animate() {
        if (!ctx) return;
        ctx.clearRect(0, 0, width, height);

        strands.forEach(strand => {
            strand.update();
            strand.draw();
        });
        
        mouseSpeedX = 0;

        requestAnimationFrame(animate);
    }

    window.addEventListener('resize', resize);
    resize();
    animate();
</script>
